
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Just A Startup Guy</title>
  <meta name="author" content="Eric Zou">

  
  <meta name="description" content="I&#8217;ve been on many projects where writing/runing tests were painfully slow. To test one line of change often requires me to construct a bunch &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ericzou.github.io/blog">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="Just A Startup Guy" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3633431-16']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Just A Startup Guy</a></h1>
  
    <h2>Ruby on Rails / Javascript Freelancer in San Francisco Bay Area</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ericzou.github.io/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/19/wake-up-and-smell-the-tests/">Wake Up and Smell the (Slow) Tests</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-19T09:01:00-07:00" pubdate data-updated="true">Jun 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been on many projects where writing/runing tests were painfully slow. To test one line of change often requires me to construct a bunch unrelated models, fix a few failures in other tests and patiently wait an hour or two for the tests suite to pass locally and on ci.</p>

<p>Worse, Developers often proud themselves for writing tests first, and have an excellent test coverage. These painfully slow processes for writing/running tests are often accepted as the cost of doing TDD.</p>

<p>It is not. If the test is painful to write and slow to run. It&#8217;s a smell that our code/test can be structured better. Rather than blindly writing more tests, I usually ask myself the following questions.</p>

<h3>Do my tests have too many inter-process communications?</h3>

<p>Inter-process communications are an order of magnitutue slower than in-memory communications. Mock out the interfaces if that&#8217;s the case. Better yet, try design a system where these external connections are explicitly inversely injected. Then during the test, I just need to swap in a fake connection.</p>

<h3>Am I testing at the right level?</h3>

<p>Intergration tests are a necessary evil and need to be treated as such. Writing an intergration test for an if statement change in the model can often be inapproproate. Unfortunately, integration tests, once in place provides a false sense of security and are usually difficult to remove. So it&#8217;s important to be very causious about them from the very beginning.</p>

<h3>Is my test setup complicated?</h3>

<p>If I have to create lots of objects to able to test my object. That&#8217;s usually a sign the objects are too coupled together. I&#8217;ve seen this happen a lot in Rails projects, since the framework itself does very little to prevent this.  If I spend more time setting up the tests than actually writing it, I would investigate it a bit to see if I can decouple the code dependencies.</p>

<h3>Can I modulize part of the project?</h3>

<p>Modulized code base means a decoupled structure, which leads to a simplier test setup, smaller test suites, and faster test runs.</p>

<h3>Is my tests too &#8216;meta&#8217;</h3>

<p>Writing tests that generates more tests seems clever. But it sufer from a number of problems:
* Easily go overboard with it: In one of my projects, we went &#8216;meta&#8217; for generating access control tests - a test for every role(guess, user, admin, etc), and every path to combination to make sure current user can/cannot access certain pages. That alone generated thousands of tests and took a long time to run.</p>

<ul>
<li>Lot of valueless tests: When we have tests like these, we are often testing every possible scenario. When we really care only the common cases and edge cases.</li>
<li>Too abstract: The intent of the each tests should be very clear and easy to read, but that&#8217;s usually not the case when tests are &#8216;meta&#8217;</li>
<li>Hard to debug: It&#8217;s often hard to run a single generated test without running the entire thing, and the line numbers are usually wrong.</li>
</ul>


<h3>Does my test code look boring or repetitive?</h3>

<p>Tests should be interesting to write. If they look repetitive, that usually signals the userage of the code will have a common pattern with slight variarations. I would reconsider see if I can abstract the common pattern out into a behavior and a separate test for for that behavior.</p>

<h2>Final Thought</h2>

<p>Many of us have grown custom to these slow and painful tests. Many of us have followed the TDD without really understand its spirit.  Maybe its time to wake up and smell the tests, they are trying to tell you something.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/03/using-angularjs-for-existing-rails-app/">Using AngularJS for Existing Rails App</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-03T21:05:00-07:00" pubdate data-updated="true">May 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In one of my projects, we were tasked to put AngularJS on top of an existing Rails app.  We wanted to keep the business impact at a minimum.  This means that we had to gradually make the transition while adding more end-user features.</p>

<p>Since retro fitting a client side framework is pretty common for many Rails apps, I&#8217;m going to share some of the problems I&#8217;ve encoutered, and possible approaches I used.</p>

<h2>HAML or HTML?</h2>

<p>Our views were written in haml and generated from the server side. I liked it and would like to continue using it for generating view markup. Unfortunatelly, we didn&#8217;t find a javascript library that work <em>exact</em> the same as ruby&#8217;s haml.</p>

<p>We ended up created a <code>TemplatesController</code> and route all of the template fetching requests though this <code>TemplatesController</code>. From browser&#8217;s perspective, we are still serving static HTML, but we were able to write it in HAML from the server side.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># TemplatesController</span>
</span><span class='line'><span class="k">class</span> <span class="nc">TemplatesController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="n">path</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">file</span><span class="p">:</span> <span class="s2">&quot;/views/templates/</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">handler</span><span class="p">:</span> <span class="o">[</span><span class="ss">:haml</span><span class="o">]</span><span class="p">,</span> <span class="ss">layout</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># router.rb</span>
</span><span class='line'><span class="c1"># routes template/* to a template controller</span>
</span><span class='line'><span class="n">match</span> <span class="s1">&#39;/template/*path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;templates#show&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>One added benefit was that because we are still on the server side, we have access to things like <code>User::ROLES</code> and <code>I18n.t 'store.title'</code>, which we otherwise have to duplicate at the client side.</p>

<h2>Do we have to write validations twice?</h2>

<p>I really like the ActiveRecord error messages. It has good defaults, easily configurable, and intergate well with i18n. At the same time, I want the good user experience thatâ€™s provided by the client-side validation. Refreshing the page to see errors is so 2008.</p>

<p>I also don&#8217;t want to write our validations and messages twice. The server side already has validations, we just need to pipe the error messages out to the page via ajax. Its easy with AngualrJS</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&#39;/users&#39;</span><span class="err">,</span> <span class="na">methpd=</span><span class="s">&#39;post&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;fieldset&gt;</span>
</span><span class='line'>    <span class="nt">&lt;label&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;text&#39;</span> <span class="na">ng-model=</span><span class="s">&#39;name&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div&gt;</span>{{errors[&#39;name&#39;]}}<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/fieldset&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;submit&#39;</span> <span class="na">ng-click=</span><span class="s">&#39;submit&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/form&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">FooCtrl</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">httpRequest</span><span class="p">({},</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">success</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">setErrors</span><span class="p">)</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scoppe</span><span class="p">.</span><span class="nx">setErrors</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">scope</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">errors</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Every time the user clicks submit, without any client-side validation, the form issues an ajax request. We rely on ActiveRecord to do the validation, feed us with the correct error messages, and store the errors in an errors object in javascript, with Angular&#8217;s two-way binding. The view then gets updated automatically.</p>

<p>Note: The approach works for us becuase our application only validates the input after the user attempts to submit the form. It might not work well in your case.</p>

<h2>Turn functions into services</h2>

<p>We use CanCan for access control. In the view, we show and hide certain elements depending on the current user&#8217;s role. The code snippet below hides the Edit button if <code>current_user</code> does not have the <code>ability</code> to <code>manage</code> <code>Post</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>  <span class="p">-</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">ability</span><span class="o">.</span><span class="n">can?</span><span class="p">(</span><span class="ss">:manage</span><span class="p">,</span> <span class="no">Post</span><span class="p">)</span>
</span><span class='line'>    &lt;button&gt;Edit&lt;/button&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Since we are switching to client side templates, we don&#8217;t have direct access to <code>ability</code> object anymore, but we can turn the CanCan ability into a service call. A get request to <code>/abilities.json</code> will return something like this for the current user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;manage&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;User&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Post&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="err">...</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;read&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;User&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Post&quot;</span><span class="p">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="err">...</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;Update&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;User&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Post&quot;</span><span class="p">:</span> <span class="kc">false</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="err">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the view, we can choose to show/hide elements based on the user&#8217;s role again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;button</span> <span class="na">ng-show=</span><span class="s">&quot;canManage(&#39;User&#39;)&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">function</span> <span class="nx">FooCtrl</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">scope</span><span class="p">.</span><span class="nx">canManage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">scope</span><span class="p">.</span><span class="nx">manage</span><span class="p">[</span><span class="nx">model</span><span class="p">]</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/06/19/wake-up-and-smell-the-tests/">Wake up and smell the (slow) tests</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/03/using-angularjs-for-existing-rails-app/">Using AngularJS for existing Rails app</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Eric Zou -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
